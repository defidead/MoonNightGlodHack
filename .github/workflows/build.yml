name: Build libgoldhack.so

on:
  push:
    paths:
      - 'gold_hack.c'
      - '.github/workflows/build.yml'
  workflow_dispatch:
    inputs:
      target_gold:
        description: '目标金币值'
        required: false
        default: '99999'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set gold value
        id: config
        run: |
          GOLD="${{ github.event.inputs.target_gold }}"
          echo "gold=${GOLD:-99999}" >> $GITHUB_OUTPUT

      - name: Find NDK
        id: ndk
        run: |
          echo "NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_OUTPUT
          ls $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android*-clang | tail -1

      - name: Build arm64-v8a
        run: |
          # 查找可用的 clang 编译器
          echo "NDK_HOME: $ANDROID_NDK_HOME"
          TOOLCHAIN=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin
          ls $TOOLCHAIN/aarch64-linux-android*-clang 2>/dev/null | head -5
          
          # 优先使用高版本 API
          if [ -f "$TOOLCHAIN/aarch64-linux-android35-clang" ]; then
            CC="$TOOLCHAIN/aarch64-linux-android35-clang"
          elif [ -f "$TOOLCHAIN/aarch64-linux-android31-clang" ]; then
            CC="$TOOLCHAIN/aarch64-linux-android31-clang"
          else
            CC="$TOOLCHAIN/aarch64-linux-android21-clang"
          fi
          echo "Using compiler: $CC"
          $CC --version
          
          # 编译，将错误输出到文件
          $CC \
            -shared -fPIC -O2 \
            -DTARGET_GOLD=${{ steps.config.outputs.gold }} \
            -o libgoldhack.so \
            gold_hack.c \
            -llog -lc \
            -Wno-pointer-to-int-cast \
            -Wno-int-to-pointer-cast \
            -Wno-format \
            2>&1 | tee build_log.txt
          
          # 检查编译结果
          if [ -f libgoldhack.so ]; then
            file libgoldhack.so
            readelf -d libgoldhack.so | head -20
            ls -lh libgoldhack.so
          else
            echo "=== BUILD FAILED ==="
            cat build_log.txt
            exit 1
          fi

      - name: Build armeabi-v7a
        continue-on-error: true
        run: |
          TOOLCHAIN=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin
          if [ -f "$TOOLCHAIN/armv7a-linux-androideabi35-clang" ]; then
            CC="$TOOLCHAIN/armv7a-linux-androideabi35-clang"
          elif [ -f "$TOOLCHAIN/armv7a-linux-androideabi31-clang" ]; then
            CC="$TOOLCHAIN/armv7a-linux-androideabi31-clang"
          else
            CC="$TOOLCHAIN/armv7a-linux-androideabi21-clang"
          fi
          echo "Using compiler: $CC"
          
          $CC \
            -shared -fPIC -O2 \
            -DTARGET_GOLD=${{ steps.config.outputs.gold }} \
            -o libgoldhack_armv7a.so \
            gold_hack.c \
            -llog -lc \
            -Wno-pointer-to-int-cast \
            -Wno-int-to-pointer-cast \
            -Wno-format
          
          ls -lh libgoldhack*.so 2>/dev/null || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libgoldhack
          path: |
            libgoldhack.so
            libgoldhack_armv7a.so
          if-no-files-found: error
